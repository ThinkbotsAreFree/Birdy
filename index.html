<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>BirdyVM</title>
    <link rel="stylesheet" href="normalize.css" type="text/css">
    <link rel="stylesheet" href="main.css" type="text/css">
</head>

<body>
    <div id="main">
        <img id="banner" src="birdy.png">
        <h2>BirdyVM</h2>
        <div class="right">Editor</div>
        <textarea id="editor"></textarea>
        <button onclick="parseEditor(true)">Parse</button>
        <button onclick="sys.step(false, false, this)">Step once</button>
        <button onclick="sys.step(true, false, this)">Step while</button>
        <button onclick="sys.step(true, true, this)">Run loop</button>

        <br><br>
        <div class="right">Output</div>
        <textarea id="output"></textarea>

        <br><br>
        <div class="right">Input</div>
        <textarea id="input"></textarea>
        <button onclick="userPublish()">Publish</button>

        <script src="biwascheme-0.6.9.js"></script>

        <script src="comment-parser.js"></script>
        <script src="parser.js"></script>
        <script src="birdy.js"></script>
    </div>

    <script>

        var onSchemeError = function (e) { console.error("[BiwaScheme]", e); };
        var biwaScheme = new BiwaScheme.Interpreter(onSchemeError);

        const editor = document.getElementById("editor");
        const output = document.getElementById("output");
        const input = document.getElementById("input");

        editor.value = "| hi there ^ hello world";
        output.value = '';
        input.value = `{
    "outChannel": "hi there",
    "signature": "user",
    "message": "go"
}`;


        function parseEditor() {

            sys.deliver = {};
            sys.unit = {};
            sys.createUnit({
                initInput: "global",
                commands: []
            }, 1);


            try {
                sys.populate(editor.value);
                sys.output("parser", "parsed");
            } catch (e) {
                sys.output("parser", e.message);
            }

            if (0) for (let u in sys.unit) {
                output.value += "\n[ID]→ " + sys.unit[u].id + " [InChannel]→ " + sys.unit[u].AST.initInput.join(", ") + '\n';
                sys.unit[u].AST.commands.forEach(command => {
                    output.value += "[Com]→ " + command.com;
                    if (command.id) output.value += " [Var]→ " + command.id;
                    if (Array.isArray(command.arg)) output.value += " [Arg]→ " + command.arg.join(", ");
                    else if (command.arg) output.value += " [Old]→ " + command.arg.old.join(", ") + " [New]→ " + command.arg.new.join(", ");
                    output.value += "\n";
                });
            }

            doTest();
        };

        //parseEditor();


        sys.createUnit({
            initInput: "global",
            commands: []
        });



        function userPublish() {

            var options = JSON.parse(input.value);
            sys.unit[1].outChannel = options.outChannel.replace(/\s+/g, ' ').split(' ');
            sys.unit[1].signature = options.signature.replace(/\s+/g, ' ').split(' ');
            sys.unit[1].publish(options.message.replace(/\s+/g, ' ').split(' '));
            sys.output("publish", "@ " + sys.unit[1].outChannel.join(' ') + " > " + options.message.replace(/\s+/g, ' '));
        }



        function doTest() {
        }



    </script>
</body>

</html>