<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>BirdyVM</title>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <link href="css/normalize.css" rel="stylesheet">
    <link href="css/bigpicture.css" rel="stylesheet">
    <link href="css/toastify.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
</head>

<body>

    <div id="toolbar">
        <button onclick="sys.step(false, false, this)">Step Once</button>
        <button onclick="sys.step(true, false, this)">Step While</button>
        <button onclick="sys.step(true, true, this)">Run Loop</button>
        <button onclick="sys.stop()">Stop Loop</button>
        <button onclick="window.open('https://github.com/ThinkbotsAreFree/Birdy', '_blank')">Help Docs</button>
        <button onclick="importLayout()">Import Layout</button>
        <button onclick="exportLayout()">Export Layout</button>
        <input id="user-input" type="text" placeholder="command">
        <img src="images/birdy-transparent.png">
    </div>

    <span id="info">
        <span id="version">BirdyVM - Version 0.2.3 - </span>
        <span id="status">Paused</span>
    </span>

    <span id="zoom">
        <span id="zoom-in" onclick="bigpicture.zoomIn()">Zoom In</span> | <span id="zoom-out"
            onclick="bigpicture.zoomOut()">Zoom Out</span>
    </span>

    <div id="bigpicture-container">
        <div id="bigpicture" data-zoom="1" data-x="721" data-y="480">
            <div id="core" class="text" data-size="20" data-x="1000" data-y="1000">[BirdyVM]</div>
        </div>
    </div>

    <div id="cycle"><img src="images/cycle.svg" width="100%"></div>

    <div id="import-export" class="hidden">
        <span id="modal-title">
            Import<br>
            Paste your code below.
        </span>
        <textarea id="editor" spellcheck="false"></textarea>
        <span id="import-export-save" onclick="saveModal()">✔️</span>
        <span id="import-export-cancel" onclick="closeModal()">❌</span>
    </div>

    <script type="text/javascript" src="js/localforage.min.js"></script>
    <script type="text/javascript" src="js/biwascheme-0.6.9.js"></script>
    <script type="text/javascript" src="js/birdy.js"></script>
    <script type="text/javascript" src="js/comment-parser.js"></script>
    <script type="text/javascript" src="js/total-parser.js"></script>
    <script type="text/javascript" src="js/screen-parser.js"></script>
    <script type="text/javascript" src="js/bigpicture.js"></script>
    <script type="text/javascript" src="js/toastify-js.js"></script>

    <script>



        var onSchemeError = function (e) { console.error("[BiwaScheme]", e); };
        var biwaScheme = new BiwaScheme.Interpreter(onSchemeError);



        sys.populate(`
            | user
        `);



        localforage.getItem("layout", function (err, layout) {

            console.log(layout);

            if (!err && layout) {
                layout = layout.replace(/\[BirdyVM\][^\n]*\n/g, '');
                importLayout(layout);
            } else
                importLayout(`Search: F3 or CTRL+F<br><br>Pan: click and drag<br><br>Move text: CTRL+click and drag<br><br>Zoom In:  PageDown or CTRL+ or<br>          mousewheel or double-click<br><br>Zoom Out: PageUp or CTRL- or<br>          mousewheel or CTRL+double-click<br><br>Biggest picture: F2 (try it twice)<br> \\1200\\950\\10`);

            if (err) sys.inhibAutoSave = true;
        });



        if (!sys.inhibAutoSave)
            setInterval(function () {
                localforage.setItem("layout", getLayout(), function (err) { });
            }, 4000);



        $("#user-input").keypress(function (e) {

            if (e.which === 13) {

                var parsed;
                try {
                    var com = $(this).val();
                    com = "| user " + com;
                    parsed = totalParser.parse(commentParser.parse(com));
                } catch (e) {
                    sys.output("system", "Parser failed: " + com);
                }
                if (parsed) {

                    sys.unit['1'].AST.commands = parsed.units[0].commands;

                    sys.jobQueue.push({
                        receiver: '1',
                        message: "user",
                        signature: "user",
                        capture: {},
                        senderId: '1'
                    });

                    if (sys.status === "Paused") sys.step(true, false, true);
                    $(this).val('');
                }
            }
        });



        function importLayout(source) {

            if (source) setLayout(source);
            else promptModal();
        }



        function setLayout(source) {

            var parsed;
            try {
                parsed = screenParser.parse(commentParser.parse(source));
            } catch (e) {
                alert(e);
                console.log(source);
            }
            if (parsed) {
                parsed.forEach(def => {
                    bigpicture.newText(
                        def.coordinates.x,
                        def.coordinates.y,
                        def.coordinates.size,
                        def.text
                    );
                });
            }
        }



        function exportLayout() {


            var layout = getLayout();
            if (!sys.inhibAutoSave)
                localforage.setItem("layout", layout, function (err) {
                    if (!err) alertModal(layout);
                });
        }



        function getLayout() {

            result = [];
            var sel = $("#bigpicture div.text")

            sel.each(ect => {
                var t = $(sel[ect]);
                result.push(t.html() + ' \\' + t.data('x') + '\\' + t.data('y') + '\\' + t.data('size'));
            });

            return result.join('\n');
        }



        var shouldCleanEditor = true;



        function alertModal(txt) {

            $("#modal-title").html("Export<br>Please copy the code below.");
            $("#editor").val(getLayout());
            $("#import-export-save")[0].style.display = "none";
            $("#import-export").removeClass("hidden");
            shouldCleanEditor = true;
        }



        function promptModal() {

            $("#modal-title").html("Import<br>Please paste your code below.");
            $("#import-export-save")[0].style.display = "block";
            $("#import-export").removeClass("hidden");
            shouldCleanEditor = false;
        }



        function closeModal() {

            $("#import-export").addClass("hidden");
            if (shouldCleanEditor) $("#editor").val('');
        }



        function saveModal() {

            $("#import-export").addClass("hidden");
            setLayout($("#editor").val());
            $("#editor").val('');
        }



    </script>
</body>

</html>